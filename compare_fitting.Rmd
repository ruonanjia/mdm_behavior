---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
library(ggplot2)
library(PerformanceAnalytics)
library(psych)
library(dplyr)
library(viridis)
```

```{r}
data_summary <- function(data, varname, groupnames){
  # Function to calculate the mean and the standard error
  # for each group
  #+++++++++++++++++++++++++
  # data : a data frame
  # varname : the name of a column containing the variable
  #to be summariezed
  # groupnames : vector of column names to be used as
  # grouping variables
  
  require(plyr)
  summary_func <- function(x, col){
    c(mean = mean(x[[col]], na.rm=TRUE),
      sd = sd(x[[col]], na.rm=TRUE)/sqrt(length(x[[col]])))
  }
  data_sum<-ddply(data, groupnames, .fun=summary_func,
                  varname)
  data_sum <- rename(data_sum, c("mean" = varname))
  return(data_sum)
}
```

```{r}
data_summary_sd <- function(data, varname, groupnames){
  # Function to calculate the mean and the standard deviation
  # for each group
  #+++++++++++++++++++++++++
  # data : a data frame
  # varname : the name of a column containing the variable
  #to be summariezed
  # groupnames : vector of column names to be used as
  # grouping variables
  
  require(plyr)
  summary_func <- function(x, col){
    c(mean = mean(x[[col]], na.rm=TRUE),
      sd = sd(x[[col]], na.rm=TRUE))
  }
  data_sum<-ddply(data, groupnames, .fun=summary_func,
                  varname)
  data_sum <- rename(data_sum, c("mean" = varname))
  return(data_sum)
}
```

# Load data sheet
```{r}
fitpar_path <- 'E:/Ruonan/Projects in the lab/MDM Project/Medical Decision Making Imaging/MDM_imaging/Behavioral Analysis/Behavior Analysis'
setwd(fitpar_path)

load("data_all_01272020.rda")
data_all$beta_t <- -data_all$beta

fit_ambigOnly <- read.csv('par_ambigOnly_02022021.csv', header = TRUE)
fit_original <- read.csv('MDM_model_fitting_parameters.csv', header = TRUE)
fit_svPar <- read.csv('par_SV100_050520.csv', header = TRUE)
log <- read.csv("log_11082019.csv", header = TRUE)

```

```{r}
data_task <- data_all[data_all$is_med == 0 & data_all$is_exclude_behavior == 0, ]
```


# Clean data sheet
```{r}
# View(fit1)
# View(fit)

fit_original = fit_original[fit_original$model == 'ambigNrisk' & fit_original$fitby == 'value' & fit_original$is_med == 0, ]
# fit3 = fit[fit$model == 'ambigNrisk' & fit$fitby == 'arbitrary', ]
# fit4 = fit[fit$model== 'ambigNrisk' & fit$fitby == 'value', ]
# included subjects
include_ids = unique(log$id[log$is_exclude_behavior == 0])

include_ids
```

combine table

```{r}
colnames(fit_ambigOnly)
fit_ambigOnly <- fit_ambigOnly[, 1:10] # monetary
# fit_ambigOnly <- fit_ambigOnly[, c(1, 11:19)]


colnames(fit_svPar)
fit_svPar <- fit_svPar[fit_svPar$is_med==0, ]
```

```{r}
colnames(fit_ambigOnly) <- c("id", "beta", "gamma", "LL", "r2", "AIC", "BIC", "model", "exitFlag", "optimizer")

fit_ambigOnly$is_med <- 0
fit_ambigOnly$is_med <- 1
fit_ambigOnly$alpha <- NaN

```

```{r}
fit_original <- fit_original %>% select(id, alpha, beta, gamma, LL, r2, AIC, BIC, model, is_med)
fit_ambigOnly <- fit_ambigOnly %>% select(id, alpha, beta, gamma, LL, r2, AIC, BIC, model, is_med)

colnames(fit_svPar)
fit_svPar <- fit_svPar %>% select(id, alpha, beta, gamma, LL, r2_adj, AIC, BIC, model, is_med)
fit_svPar <- fit_svPar %>% select(id, alpha, beta, gamma, LL, r2_adj, AIC, BIC, model, is_med, val1, val2, val3, val4)
colnames(fit_svPar)[6] <- "r2"
fit_all <- rbind(fit_original, fit_ambigOnly, fit_svPar)

fit_all
```

```{r}
# check number of participants
nrow(fit_all[is.element(fit_all$id, log$id[log$is_exclude_behavior==0]),])/3

include_idx <- is.element(fit_all$id, log$id[log$is_exclude_behavior==0])
```

# choice predicted by model
calculate P(lottery)

## make trials
```{r}
val <- c(5, 8, 12, 25)
type <- c("risk", "ambig")
uncert <- c(1, 2, 3)

trial <- expand.grid(val = val, type = type, uncert = uncert)

trial$p <- NA
trial$a <- NA


trial$p[trial$type == "ambig"] <- 0.5
trial$a[trial$type == "risk"] <- 0

trial$p[(trial$type == "risk") & (trial$uncert == 1)] <- 0.25
trial$p[(trial$type == "risk") & (trial$uncert == 2)] <- 0.5
trial$p[(trial$type == "risk") & (trial$uncert == 3)] <- 0.75

trial$a[(trial$type == "ambig") & (trial$uncert == 1)] <- 0.24
trial$a[(trial$type == "ambig") & (trial$uncert == 2)] <- 0.5
trial$a[(trial$type == "ambig") & (trial$uncert == 3)] <- 0.74

trial
 
```

## calculate choice probability predicted by model
```{r}

sub_idx <- 2
id <- fit_original$id[sub_idx]

alpha <- fit_original$alpha[sub_idx]
beta <- fit_original$beta[sub_idx]
gamma <- fit_original$gamma[sub_idx]


trial$sv <- (trial$p - beta * trial$a / 2) * trial$val ^ alpha
trial$sv_ref <- 5 ^ alpha

trial$choice_p <- 1/(1 + exp(gamma*(trial$sv - trial$sv_ref)))

# View(trial)
trial$val <- ordered(trial$val)
trial$p <- ordered(trial$p)
trial$a <- ordered(trial$a)

```

```{r}
# plot
# by value, risky trials
data2plot <- data_summary_sd(trial[trial$type =="risk", ], "choice_p", "val")

ggplot(data2plot, aes(x = val, y = choice_p)) +
  geom_bar(stat="identity", position=position_dodge(0.85), width = 0.8) +
  geom_errorbar(aes(ymin=choice_p-sd, ymax=choice_p+sd), width=0.1, size=1, position=position_dodge(0.85)) +
  # scale_fill_manual() +
  theme_classic() +
  ggtitle('Model-predicted choice probability, Risky trials') +
  theme(axis.line = element_line(size = 1)) +
  theme(axis.ticks = element_line(size = 1, color = "black")) +
  theme(axis.text = element_text(size = 12, color = "black"))

# by value, ambiguous trials
data2plot <- data_summary_sd(trial[trial$type =="ambig", ], "choice_p", "val")

ggplot(data2plot, aes(x = val, y = choice_p)) +
  geom_bar(stat="identity", position=position_dodge(0.85), width = 0.8) +
  geom_errorbar(aes(ymin=choice_p-sd, ymax=choice_p+sd), width=0.1, size=1, position=position_dodge(0.85)) +
  # scale_fill_manual() +
  theme_classic() +
  ggtitle('Model-predicted choice probability, Ambiguous trials') +
  theme(axis.line = element_line(size = 1)) +
  theme(axis.ticks = element_line(size = 1, color = "black")) +
  theme(axis.text = element_text(size = 12, color = "black"))


# by risk level, risk trials
data2plot <- data_summary_sd(trial[trial$type =="risk", ], "choice_p", "p")

ggplot(data2plot, aes(x = p, y = choice_p)) +
  geom_bar(stat="identity", position=position_dodge(0.85), width = 0.8) +
  geom_errorbar(aes(ymin=choice_p-sd, ymax=choice_p+sd), width=0.1, size=1, position=position_dodge(0.85)) +
  # scale_fill_manual() +
  theme_classic() +
  ggtitle('Model-predicted choice probability, Risky trials') +
  theme(axis.line = element_line(size = 1)) +
  theme(axis.ticks = element_line(size = 1, color = "black")) +
  theme(axis.text = element_text(size = 12, color = "black"))

# by ambiguity level, ambiguous trials
data2plot <- data_summary_sd(trial[trial$type =="ambig", ], "choice_p", "a")

ggplot(data2plot, aes(x = a, y = choice_p)) +
  geom_bar(stat="identity", position=position_dodge(0.85), width = 0.8) +
  geom_errorbar(aes(ymin=choice_p-sd, ymax=choice_p+sd), width=0.1, size=1, position=position_dodge(0.85)) +
  # scale_fill_manual() +
  theme_classic() +
  ggtitle('Model-predicted choice probability, Risky trials') +
  theme(axis.line = element_line(size = 1)) +
  theme(axis.ticks = element_line(size = 1, color = "black")) +
  theme(axis.text = element_text(size = 12, color = "black"))
```

## plot real choice
```{r}
data_sub <- data_task[data_task$id==id,]

# reorganize

colnames(data_sub)

choice_sub <- select(data_sub, r25, r50, r75, a24, a50, a74)

choice_sub <- as.data.frame(t(choice_sub))

colnames(choice_sub) <- "choice_p"

choice_sub
choice_sub$type <- c("risk", "risk", "risk", "ambig", "ambig", "ambig")
choice_sub$p <- c(0.25, 0.5, 0.75, 0.5, 0.5, 0.5)
choice_sub$a <- c(0, 0, 0, 0.24, 0.5, 0.74)

choice_sub$p <- ordered(choice_sub$p)
choice_sub$a <- ordered(choice_sub$a)
```

```{r}
# by risk level, risk trials
ggplot(choice_sub[choice_sub$type == "risk",], aes(x = p, y = choice_p)) +
  geom_bar(stat="identity", position=position_dodge(0.85), width = 0.8) +
  # scale_fill_manual() +
  theme_classic() +
  ggtitle('Model-predicted choice probability, Risky trials') +
  theme(axis.line = element_line(size = 1)) +
  theme(axis.ticks = element_line(size = 1, color = "black")) +
  theme(axis.text = element_text(size = 12, color = "black"))

# by ambiguity level, ambiguous trials
ggplot(choice_sub[choice_sub$type == "ambig",], aes(x = a, y = choice_p)) +
  geom_bar(stat="identity", position=position_dodge(0.85), width = 0.8) +
  # scale_fill_manual() +
  theme_classic() +
  ggtitle('Model-predicted choice probability, Risky trials') +
  theme(axis.line = element_line(size = 1)) +
  theme(axis.ticks = element_line(size = 1, color = "black")) +
  theme(axis.text = element_text(size = 12, color = "black"))
```

## plot model-predicted and real behavior side-by-side
```{r}
# by risk level, risky trials
model_predict <- data_summary_sd(trial[trial$type =="risk", ], "choice_p", "p")

real_choice <- choice_sub[choice_sub$type == "risk",]

model_predict$method <- "model_fitted"
real_choice$method <- "choice"

model_predict <- select(model_predict, p, choice_p, method)
real_choice <- select(real_choice, p, choice_p, method)

compare2plot <- rbind(model_predict, real_choice)

ggplot(compare2plot, aes(x = p, y = choice_p, fill = method)) +
  geom_bar(stat="identity", position=position_dodge(0.85), width = 0.8) +
  # scale_fill_manual() +
  theme_classic() +
  ggtitle('Compare model-fitted and real choice, Risky trials') +
  theme(axis.line = element_line(size = 1)) +
  theme(axis.ticks = element_line(size = 1, color = "black")) +
  theme(axis.text = element_text(size = 12, color = "black"))


# by ambiguity level, ambiguous trials
model_predict <- data_summary_sd(trial[trial$type =="ambig", ], "choice_p", "a")

real_choice <- choice_sub[choice_sub$type == "ambig",]

model_predict$method <- "model_fitted"
real_choice$method <- "choice"

model_predict <- select(model_predict, a, choice_p, method)
real_choice <- select(real_choice, a, choice_p, method)

compare2plot <- rbind(model_predict, real_choice)

ggplot(compare2plot, aes(x = a, y = choice_p, fill = method)) +
  geom_bar(stat="identity", position=position_dodge(0.85), width = 0.8) +
  # scale_fill_manual() +
  theme_classic() +
  ggtitle('Compare model-fitted and real choice, Ambiguous trials') +
  theme(axis.line = element_line(size = 1)) +
  theme(axis.ticks = element_line(size = 1, color = "black")) +
  theme(axis.text = element_text(size = 12, color = "black"))
```


plot by outcome, and risk/ambiguity level

plot the choices

compare

compare on average

compare each subject


# BIC
```{r}
fit_plot <- data_summary(fit_all[include_idx,], varname = "BIC", groupnames=c("model"))

ggplot(data = fit_plot, aes(x = model, y = BIC, fill = model)) +
  geom_bar(stat="identity", position=position_dodge(0.85), width = 0.8) +
  geom_errorbar(aes(ymin=BIC-sd, ymax=BIC+sd), width=0.1, size=1, position=position_dodge(0.85)) +
  # scale_fill_manual() +
  theme_classic() +
  ggtitle('Compare model fitting') +
  theme(axis.line = element_line(size = 1)) +
  theme(axis.ticks = element_line(size = 1, color = "black")) +
  theme(axis.text = element_text(size = 12, color = "black"))
```

```{r}
fit_scatter <- data.frame(beta_ambigNrisk = fit_all$beta[is.element(fit_all$id, log$id[log$is_exclude_behavior==0]) & fit_all$model == "ambigNrisk"],
                          beta_ambigOnly = fit_all$beta[is.element(fit_all$id, log$id[log$is_exclude_behavior==0]) & fit_all$model == "ambigOnly"],
                          beta_svPar = fit_all$beta[is.element(fit_all$id, log$id[log$is_exclude_behavior==0]) & fit_all$model == "ambigSVPar"],
                          gamma_ambigNrisk = fit_all$gamma[is.element(fit_all$id, log$id[log$is_exclude_behavior==0]) & fit_all$model == "ambigNrisk"],
                          gamma_ambigOnly = fit_all$gamma[is.element(fit_all$id, log$id[log$is_exclude_behavior==0]) & fit_all$model == "ambigOnly"],
                          gamma_svPar = fit_all$gamma[is.element(fit_all$id, log$id[log$is_exclude_behavior==0]) & fit_all$model == "ambigSVPar"])


ggplot(fit_scatter, aes(x=beta_ambigNrisk, y=beta_ambigOnly)) +
  geom_point() 
  # scale_x_continuous(limits = c(-0.8, 1.7)) +
  # scale_y_continuous(limits=c(-3, 5))

ggplot(fit_scatter, aes(x=gamma_ambigNrisk, y=gamma_ambigOnly)) +
  geom_point() 
  # scale_y_continuous(limits = c(-15, 1))
```

# Medical arbitrary ambigNrisk model, plot the subjective value
```{r}
val_arb = c(0, 1, 2, 3, 4)

fit_original$val0_recov <- val_arb[1]^fit_original$alpha
fit_original$val1_recov <- val_arb[2]^fit_original$alpha
fit_original$val2_recov <- val_arb[3]^fit_original$alpha
fit_original$val3_recov <- val_arb[4]^fit_original$alpha
fit_original$val4_recov <- val_arb[5]^fit_original$alpha


fit_original$val4_recov

```

# Monetary objective value ambigNrisk model, plot the subjective value
```{r}
val_arb = c(0, 5, 8, 12, 25)

fit_original$val0_recov <- val_arb[1]^fit_original$alpha
fit_original$val1_recov <- val_arb[2]^fit_original$alpha
fit_original$val2_recov <- val_arb[3]^fit_original$alpha
fit_original$val3_recov <- val_arb[4]^fit_original$alpha
fit_original$val4_recov <- val_arb[5]^fit_original$alpha


fit_original$val4_recov

```

## reorganize sheet

original model, arbitrary value
```{r}
idx = 1
# rm(list=c("estimate_original", "estimate_single"))

for (val_level in c("0", "1", "2", "3", "4")) {

  estimate_single = fit_original %>% select(id, contains(paste("val", val_level, sep = "")))
  
  estimate_single$val_level = as.numeric(val_level)
  
  names(estimate_single)[2] = "val_original" 
  
  if (idx == 1) {
    estimate_original = estimate_single
  } else {
    estimate_original = rbind(estimate_original, estimate_single)
  }
  
  idx = idx + 1

  
}

estimate_original$id <- as.factor(estimate_original$id)
```


ambigSVPar model
```{r}
idx = 1
# rm(list=c("estimate_svPar", "estimate_single"))

for (val_level in c("0", "1", "2", "3", "4")) {

  if (val_level == "0") {
    estimate_single = fit_svPar %>% select(id, val1)    
    estimate_single$val1 = 0
  }  else {
    estimate_single = fit_svPar %>% select(id, contains(paste("val", val_level, sep = "")))
  }
  
  estimate_single$val_level = as.numeric(val_level)
  
  names(estimate_single)[2] = "val_svPar" 

  if (idx == 1) {
    estimate_svPar = estimate_single
  } else {
    estimate_svPar = rbind(estimate_svPar, estimate_single)
  }
  
  idx = idx + 1
  
}

estimate_svPar$id <- as.factor(estimate_svPar$id)
```

```{r}
estimate <- merge(estimate_original, estimate_svPar, by=c("id", "val_level"))
```


## Normzlize model-estimated sv and subjective rating
```{r}

ids <- unique(estimate$id)

estimate$val_original_norm = NA
estimate$val_svPar_norm = NA

for (id in ids){
  estimate$val_original_norm[estimate$id==id] <- scale(estimate$val_original[estimate$id==id], center = TRUE, scale = TRUE)
  
    estimate$val_svPar_norm[estimate$id==id] <- scale(estimate$val_svPar[estimate$id==id], center = TRUE, scale = TRUE)
}

```

monetary objective values
```{r}
colnames(estimate)
estimate$val_objective <- 0

estimate$val_objective[estimate$val_level==1] <- 5
estimate$val_objective[estimate$val_level==2] <- 8
estimate$val_objective[estimate$val_level==3] <- 12
estimate$val_objective[estimate$val_level==4] <- 25

```

## plot

```{r}
plot_idx <- is.element(estimate$id, include_ids)
```

original model estimated value against level
```{r}
alpha_value <- 0.5
ggplot(estimate[plot_idx,], aes(x = val_objective, y = val_original_norm, color = id)) +
  geom_point(size = 2) + geom_line(size = 1, alpha = alpha_value) +
  scale_color_viridis(discrete = TRUE, option = "A") +
  theme(panel.background = element_rect(fill = "grey80"),
        legend.position="none") +
  ggtitle('Model-estimate subjective value, Original model')

```

ambigSVPar model estimated value against level
```{r}
alpha_value <- 0.5
ggplot(estimate[plot_idx,], aes(x = val_objective, y = val_svPar_norm, color = id)) +
  geom_point(size = 2) + geom_line(size = 1, alpha = alpha_value) +
  scale_color_viridis(discrete = TRUE, option = "A") +
  theme(panel.background = element_rect(fill = "grey80"),
        legend.position="none") +
  ggtitle('Model-estimate subjective value, ambigSVPar model')

```

ambigSVPar model estimated value against original model estimated value
```{r}
alpha_value <- 0.2
ggplot(estimate[plot_idx,], aes(x = val_original_norm, y = val_svPar_norm, color = id)) +
  geom_point(size = 1) + geom_line(size = 1, alpha = alpha_value) +
  scale_color_viridis(discrete = TRUE, option = "A") +
  theme(panel.background = element_rect(fill = "grey80"),
        legend.position = "none") +
  ggtitle('Model-fitted value comparison')
```

# older
```{r}
fit_1 = fit1 %>% select((id),(is_med),(alpha),(beta),(gamma),(val1), (val2), (val3), (val4), (LL),(AIC),(BIC),(model))

fit_2 = fit2 %>% select((id),(is_med),(alpha),(beta),(gamma),(LL),(AIC),(BIC),(model))
fit_2$val1 <- NaN
fit_2$val2 <- NaN
fit_2$val3 <- NaN
fit_2$val4 <- NaN
fit_2$model <- "ambigNrisk_rating"
# fit_2 = fit_2 %>% rename(alpha2=alpha, beta2=beta, gamma2 = gamma)

fit_3 = fit3 %>% select((id),(is_med),(alpha),(beta),(gamma),(LL),(AIC),(BIC),(model))
fit_3$val1 <- NaN
fit_3$val2 <- NaN
fit_3$val3 <- NaN
fit_3$val4 <- NaN
fit_3$model <- "ambigNrisk_arbitrary"

fit_4 = fit4 %>% select((id),(is_med),(alpha),(beta),(gamma),(LL),(AIC),(BIC),(model))
fit_4$val1 <- NaN
fit_4$val2 <- NaN
fit_4$val3 <- NaN
fit_4$val4 <- NaN
fit_4$model <- "ambigNrisk_value"

# fit_3 = fit_3 %>% rename(alpha2=alpha, beta2=beta, gamma2 = gamma)

fit_all <- rbind(fit_1, fit_2, fit_3, fit_4)
fit_all$id <- as.factor(fit_all$id)
fit_all$is_med <- as.factor(fit_all$is_med)
fit_all$model <- as.factor(fit_all$model)

names(fit_all)

# write.csv(fit_all, 'E:/Ruonan/Projects in the lab/MDM Project/Medical Decision Making Imaging/MDM_imaging/Behavioral Analysis/Behavior Analysis/compare_model_fitting.csv')
```


plot
```{r}
fit_plot <- data_summary(fit_all[fit_all$model != "ambigNrisk_value",], varname = "BIC", groupnames=c("is_med", "model"))

ggplot(data = fit_plot, aes(x = is_med, y = BIC, fill = model)) +
  geom_bar(stat="identity", position=position_dodge(0.85), width = 0.8) +
  geom_errorbar(aes(ymin=BIC-sd, ymax=BIC+sd), width=0.1, size=1, position=position_dodge(0.85)) +
  # scale_fill_manual() +
  theme_classic() +
  ggtitle('Compare model fitting') +
  theme(axis.line = element_line(size = 1)) +
  theme(axis.ticks = element_line(size = 1, color = "black")) +
  theme(axis.text = element_text(size = 12, color = "black"))

fit_plot <- data_summary(fit_all[fit_all$model != "ambigNrisk_value",], varname = "AIC", groupnames=c("is_med", "model"))

ggplot(data = fit_plot, aes(x = is_med, y = AIC, fill = model)) +
  geom_bar(stat="identity", position=position_dodge(0.85), width = 0.8) +
  geom_errorbar(aes(ymin=AIC-sd, ymax=AIC+sd), width=0.1, size=1, position=position_dodge(0.85)) +
  # scale_fill_viridis(discrete = TRUE)+
  scale_x_discrete("is_med", limits = c("1","0"), labels = c("Medical", "Monetary")) +
  theme_classic() +
  ggtitle('Compare model fitting') +
  theme(axis.line = element_line(size = 1)) +
  theme(axis.ticks = element_line(size = 1, color = "black")) +
  theme(axis.text = element_text(size = 12, color = "black"))


fit_plot <- data_summary(fit_all, varname = "LL", groupnames=c("is_med", "model"))

ggplot(data = fit_plot, aes(x = is_med, y = LL, fill = model)) +
  geom_bar(stat="identity", position=position_dodge(0.85), width = 0.8) +
  geom_errorbar(aes(ymin=LL-sd, ymax=LL+sd), width=0.1, size=1, position=position_dodge(0.85)) +
  # scale_fill_manual(limits = c(1,0), values = c( 'darkorange3', 'olivedrab'), labels = c('Medical', 'Monetary')) +
  theme_classic() +
  ggtitle('Compare model fitting') +
  theme(axis.line = element_line(size = 1)) +
  theme(axis.ticks = element_line(size = 1, color = "black")) +
  theme(axis.text = element_text(size = 12, color = "black"))



```

compare models with monetary fitting only
```{r}
fit_plot <- data_summary(fit_all[fit_all$is_med == 0 & (fit_all$model == "ambigNrisk_value" | fit_all$model == "ambigSVPar") ,], varname = "BIC", groupnames=c("model"))

ggplot(data = fit_plot, aes(x = model, y = BIC, fill = model)) +
  geom_bar(stat="identity", position=position_dodge(0.85), width = 0.8) +
  geom_errorbar(aes(ymin=BIC-sd, ymax=BIC+sd), width=0.1, size=1, position=position_dodge(0.85)) +
  # scale_fill_manual() +
  theme_classic() +
  ggtitle('Compare model fitting') +
  theme(axis.line = element_line(size = 1)) +
  theme(axis.ticks = element_line(size = 1, color = "black")) +
  theme(axis.text = element_text(size = 12, color = "black"))

fit_plot <- data_summary(fit_all[fit_all$is_med == 0 & (fit_all$model == "ambigNrisk_value" | fit_all$model == "ambigSVPar") ,], varname = "AIC", groupnames=c("model"))

ggplot(data = fit_plot, aes(x = model, y = AIC, fill = model)) +
  geom_bar(stat="identity", position=position_dodge(0.85), width = 0.8) +
  geom_errorbar(aes(ymin=AIC-sd, ymax=AIC+sd), width=0.1, size=1, position=position_dodge(0.85)) +
  # scale_fill_manual() +
  theme_classic() +
  ggtitle('Compare model fitting') +
  theme(axis.line = element_line(size = 1)) +
  theme(axis.ticks = element_line(size = 1, color = "black")) +
  theme(axis.text = element_text(size = 12, color = "black"))

```


Compare model stats
```{r}
# make sure id pairing
plot(as.numeric(fit_all$id[fit_all$is_med == 0 & fit_all$model == "ambigSVPar"]),
     as.numeric(fit_all$id[fit_all$is_med == 0 & fit_all$model == "ambigNrisk_rating"]))

plot(as.numeric(fit_all$id[fit_all$is_med == 0 & fit_all$model == "ambigSVPar"]),
     as.numeric(fit_all$id[fit_all$is_med == 0 & fit_all$model == "ambigNrisk_arbitrary"]))

# stats:
test1 <- t.test(fit_all$AIC[fit_all$is_med == 1 & fit_all$model == "ambigSVPar"],
       fit_all$AIC[fit_all$is_med == 1 & fit_all$model == "ambigNrisk_rating"],
       paired = TRUE)

test2 <- t.test(fit_all$AIC[fit_all$is_med == 1 & fit_all$model == "ambigSVPar"],
       fit_all$AIC[fit_all$is_med == 1 & fit_all$model == "ambigNrisk_arbitrary"],
       paired = TRUE)

test3 <- t.test(fit_all$AIC[fit_all$is_med == 1 & fit_all$model == "ambigNrisk_rating"],
       fit_all$AIC[fit_all$is_med == 1 & fit_all$model == "ambigNrisk_arbitrary"],
       paired = TRUE)

p.adjust(c(test1$p.value, test2$p.value, test3$p.value), method = "fdr")

# monetary
test1 <- t.test(fit_all$AIC[fit_all$is_med == 0 & fit_all$model == "ambigSVPar"],
       fit_all$AIC[fit_all$is_med == 0 & fit_all$model == "ambigNrisk_rating"],
       paired = TRUE)

test2 <- t.test(fit_all$AIC[fit_all$is_med == 0 & fit_all$model == "ambigSVPar"],
       fit_all$AIC[fit_all$is_med == 0 & fit_all$model == "ambigNrisk_arbitrary"],
       paired = TRUE)

test3 <- t.test(fit_all$AIC[fit_all$is_med == 0 & fit_all$model == "ambigNrisk_rating"],
       fit_all$AIC[fit_all$is_med == 0 & fit_all$model == "ambigNrisk_arbitrary"],
       paired = TRUE)

p.adjust(c(test1$p.value, test2$p.value, test3$p.value), method = "fdr")
```








Compare by looking at different waves
Load data sheet
```{r}
fitpar_path <- 'D:/Ruonan/Projects in the lab/MDM Project/Medical Decision Making Imaging/MDM_imaging/Behavioral Analysis/Behavior fitpar files'

wave1 = '09300119'
wave2 = '09300219'
wave3 = '08230319'
# wave4 = ''

file1 = file.path(fitpar_path, paste('Behavior data fitpar_', wave1, sep=''), paste('param_Behavior data fitpar_', wave1, '.txt', sep=''))
file2 = file.path(fitpar_path, paste('Behavior data fitpar_', wave2, sep=''), paste('param_Behavior data fitpar_', wave2, '.txt', sep=''))
file3 = file.path(fitpar_path, paste('Behavior data fitpar_', wave3, sep=''), paste('param_Behavior data fitpar_', wave3, '.txt', sep=''))


fit1 <- read.delim(file1, header = TRUE, sep = "\t")
fit2 <- read.delim(file2, header = TRUE, sep = "\t")
fit3 <- read.delim(file3, header = TRUE, sep = "\t")

View(fit2)
```


```{r}
fit1$val_start = 1
fit2$val_start = 2
fit3$val_start = 3
colnames(fit1)
```

```{r}
names(fit1)
# monetary values
val_plot = rbind(fit1[,c(5:8, 30)], fit2[,c(5:8, 30)], fit3[,c(5:8, 30)])
val_plot$val_start = as.factor(val_plot$val_start)
val_plot$id = as.factor(fit1$id)

# medical values
val_plot = rbind(fit1[,c(19:22, 30)], fit2[,c(19:22, 30)], fit3[,c(19:22, 30)])
val_plot$val_start = as.factor(val_plot$val_start)
val_plot$id = as.factor(fit1$id)
```

```{r}
val2plot <- data_summary(val_plot,varname='val1_mon',groupnames=c("val_start"))
ggplot(data=val2plot,aes(x=val_start, y = val1_mon), fill=val_start) + 
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=val1_mon-sd, ymax=val1_mon+sd), width=0.2, position=position_dodge(0.9))

val2plot <- data_summary(val_plot,varname='val2_mon',groupnames=c("val_start"))
ggplot(data=val2plot,aes(x=val_start, y = val2_mon), fill=val_start) + 
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=val2_mon-sd, ymax=val2_mon+sd), width=0.2, position=position_dodge(0.9))

val2plot <- data_summary(val_plot,varname='val3_mon',groupnames=c("val_start"))
ggplot(data=val2plot,aes(x=val_start, y = val3_mon), fill=val_start) + 
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=val3_mon-sd, ymax=val3_mon+sd), width=0.2, position=position_dodge(0.9))

val2plot <- data_summary(val_plot,varname='val4_mon',groupnames=c("val_start"))
ggplot(data=val2plot,aes(x=val_start, y = val4_mon), fill=val_start) + 
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=val4_mon-sd, ymax=val4_mon+sd), width=0.2, position=position_dodge(0.9))

View(val_plot)

```


Nomalize value
```{r}
colnames(val_plot)

val_norm <- as.data.frame(t(apply(val_plot[,1:4], 1, function(x) (x - mean(x))/sd(x))))

# monetary
val_plot[, 7:10] = data.frame("val1_mon_norm" = val_norm[,1],
                             "val2_mon_norm" = val_norm[,2],
                             "val3_mon_norm" = val_norm[,3],
                             "val4_mon_norm" = val_norm[,4])

# medical
val_plot[, 7:10] = data.frame("val1_med_norm" = val_norm[,1],
                             "val2_med_norm" = val_norm[,2],
                             "val3_med_norm" = val_norm[,3],
                             "val4_med_norm" = val_norm[,4])
```

reorganize data frame for plotting values
```{r}
val_plot2 <- val_plot

# # monetary
# colnames(val_plot2)[7] <- 'val_mon_norm'
# colnames(val_plot2)[8] <- 'val_mon_norm'
# colnames(val_plot2)[9] <- 'val_mon_norm'
# colnames(val_plot2)[10] <- 'val_mon_norm'
# 
# colnames(val_plot2)[1] <- 'val_mon'
# colnames(val_plot2)[2] <- 'val_mon'
# colnames(val_plot2)[3] <- 'val_mon'
# colnames(val_plot2)[4] <- 'val_mon'

# medical
colnames(val_plot2)[7] <- 'val_med_norm'
colnames(val_plot2)[8] <- 'val_med_norm'
colnames(val_plot2)[9] <- 'val_med_norm'
colnames(val_plot2)[10] <- 'val_med_norm'

colnames(val_plot2)[1] <- 'val_med'
colnames(val_plot2)[2] <- 'val_med'
colnames(val_plot2)[3] <- 'val_med'
colnames(val_plot2)[4] <- 'val_med'

View(val_plot2)

val_plot2$level1 <- 1
val_plot2$level2 <- 2
val_plot2$level3 <- 3
val_plot2$level4 <- 4

colnames(val_plot2)

colnames(val_plot2)[11:14] <- "level"

val_plot2$reward1 <- 5
val_plot2$reward2 <- 8
val_plot2$reward3 <- 12
val_plot2$reward4 <- 25

colnames(val_plot2)[15:18] <- "reward"

colnames(val_plot2)

val_plot_re <- rbind(val_plot2[,c(6,5,1,7,11,15)],val_plot2[,c(6,5,2,8,12,16)], val_plot2[,c(6,5,3,9,13,17)],val_plot2[,c(6,5,4,10,14,18)])

View(val_plot_re)
```


Plot distributions of fitted value parameters
```{r}
val_plot_re$level <- as.factor(val_plot_re$level)
val_start2plot = 3
ggplot(val_plot_re[val_plot_re$val_start == val_start2plot,], aes(x=val_mon, fill = level, color = level)) +
  geom_histogram(position = "identity", alpha = 0.6) +
  # geom_histogram(position = "identity", alpha = 0.6, breaks=seq(0,1000,10)) +
  scale_fill_brewer(palette="YlOrRd") +
  scale_color_brewer(palette="YlOrRd") +
  ggtitle(paste("Value search starting point", val_start2plot))
```

Distribution of normalized values
```{r}
val_plot_re$level <- as.factor(val_plot_re$level)
val_start2plot = 2
ggplot(val_plot_re[val_plot_re$val_start == val_start2plot,], aes(x=val_med_norm, fill = level, color = level)) +
  geom_histogram(position = "identity", alpha = 0.6) +
  # geom_histogram(position = "identity", alpha = 0.6, breaks=seq(-1.6,1.6,0.05)) +
  scale_fill_brewer(palette="YlOrRd") +
  scale_color_brewer(palette="YlOrRd") +
  ggtitle(paste("Value search starting point", val_start2plot))
```

Correlation between normalized values, monetary
```{r}
monpar_plot <- data.frame('val1_norm_10' = val_plot$val1_mon_norm[val_plot$val_start==10],
                          'val1_norm_50' = val_plot$val1_mon_norm[val_plot$val_start==50],
                          'val1_norm_100' = val_plot$val1_mon_norm[val_plot$val_start==100])

chart.Correlation(monpar_plot)

monpar_plot <- data.frame('val2_norm_10' = val_plot$val2_mon_norm[val_plot$val_start==10],
                          'val2_norm_50' = val_plot$val2_mon_norm[val_plot$val_start==50],
                          'val2_norm_100' = val_plot$val2_mon_norm[val_plot$val_start==100])

chart.Correlation(monpar_plot)

monpar_plot <- data.frame('val3_norm_10' = val_plot$val3_mon_norm[val_plot$val_start==10],
                          'val3_norm_50' = val_plot$val3_mon_norm[val_plot$val_start==50],
                          'val3_norm_100' = val_plot$val3_mon_norm[val_plot$val_start==100])

chart.Correlation(monpar_plot)

monpar_plot <- data.frame('val4_norm_10' = val_plot$val4_mon_norm[val_plot$val_start==10],
                          'val4_norm_50' = val_plot$val4_mon_norm[val_plot$val_start==50],
                          'val4_norm_100' = val_plot$val4_mon_norm[val_plot$val_start==100])

chart.Correlation(monpar_plot)
```

Correlation between normalized values, medical
```{r}
medpar_plot <- data.frame('val1_norm_10' = val_plot$val1_med_norm[val_plot$val_start==10],
                          'val1_norm_50' = val_plot$val1_med_norm[val_plot$val_start==50],
                          'val1_norm_100' = val_plot$val1_med_norm[val_plot$val_start==100])

chart.Correlation(medpar_plot)

medpar_plot <- data.frame('val2_norm_10' = val_plot$val2_med_norm[val_plot$val_start==10],
                          'val2_norm_50' = val_plot$val2_med_norm[val_plot$val_start==50],
                          'val2_norm_100' = val_plot$val2_med_norm[val_plot$val_start==100])

chart.Correlation(medpar_plot)

medpar_plot <- data.frame('val3_norm_10' = val_plot$val3_med_norm[val_plot$val_start==10],
                          'val3_norm_50' = val_plot$val3_med_norm[val_plot$val_start==50],
                          'val3_norm_100' = val_plot$val3_med_norm[val_plot$val_start==100])

chart.Correlation(medpar_plot)

medpar_plot <- data.frame('val4_norm_10' = val_plot$val4_med_norm[val_plot$val_start==10],
                          'val4_norm_50' = val_plot$val4_med_norm[val_plot$val_start==50],
                          'val4_norm_100' = val_plot$val4_med_norm[val_plot$val_start==100])

chart.Correlation(medpar_plot)
```


plot normalized value by value starting search point, monetary
```{r}
val2plot <- data_summary(val_plot,varname='val1_mon_norm',groupnames=c("val_start"))
ggplot(data=val2plot,aes(x=val_start, y = val1_mon_norm), fill=val_start) + 
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=val1_mon_norm-sd, ymax=val1_mon_norm+sd), width=0.2, position=position_dodge(0.9))

val2plot <- data_summary(val_plot,varname='val2_mon_norm',groupnames=c("val_start"))
ggplot(data=val2plot,aes(x=val_start, y = val2_mon_norm), fill=val_start) + 
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=val2_mon_norm-sd, ymax=val2_mon_norm+sd), width=0.2, position=position_dodge(0.9))

val2plot <- data_summary(val_plot,varname='val3_mon_norm',groupnames=c("val_start"))
ggplot(data=val2plot,aes(x=val_start, y = val3_mon_norm), fill=val_start) + 
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=val3_mon_norm-sd, ymax=val3_mon_norm+sd), width=0.2, position=position_dodge(0.9))

val2plot <- data_summary(val_plot,varname='val4_mon_norm',groupnames=c("val_start"))
ggplot(data=val2plot,aes(x=val_start, y = val4_mon_norm), fill=val_start) + 
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=val4_mon_norm-sd, ymax=val4_mon_norm+sd), width=0.2, position=position_dodge(0.9))
```

plot normalized value by value starting search point, medical
```{r}
val2plot <- data_summary(val_plot,varname='val1_med_norm',groupnames=c("val_start"))
ggplot(data=val2plot,aes(x=val_start, y = val1_med_norm), fill=val_start) + 
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=val1_med_norm-sd, ymax=val1_med_norm+sd), width=0.2, position=position_dodge(0.9))

val2plot <- data_summary(val_plot,varname='val2_med_norm',groupnames=c("val_start"))
ggplot(data=val2plot,aes(x=val_start, y = val2_med_norm), fill=val_start) + 
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=val2_med_norm-sd, ymax=val2_med_norm+sd), width=0.2, position=position_dodge(0.9))

val2plot <- data_summary(val_plot,varname='val3_med_norm',groupnames=c("val_start"))
ggplot(data=val2plot,aes(x=val_start, y = val3_med_norm), fill=val_start) + 
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=val3_med_norm-sd, ymax=val3_med_norm+sd), width=0.2, position=position_dodge(0.9))

val2plot <- data_summary(val_plot,varname='val4_med_norm',groupnames=c("val_start"))
ggplot(data=val2plot,aes(x=val_start, y = val4_med_norm), fill=val_start) + 
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=val4_med_norm-sd, ymax=val4_med_norm+sd), width=0.2, position=position_dodge(0.9))
```

Plot value parameters, monetary
```{r}
val_start2plot = 3
val2plot <- data_summary(val_plot_re[val_plot_re$val_start ==val_start2plot,],
                         varname = 'val_mon',
                         groupnames = 'level')

ggplot(val2plot, aes(x=level, y=val_mon)) + 
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=val_mon-sd, ymax=val_mon+sd), width=0.2, position=position_dodge(0.9)) + 
  ggtitle(paste('Value search starting point', val_start2plot))


val2plot <- data_summary(val_plot_re[val_plot_re$val_start ==val_start2plot,],
                         varname = 'val_mon',
                         groupnames = 'reward')

ggplot(val2plot, aes(x=reward, y=val_mon)) + 
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=val_mon-sd, ymax=val_mon+sd), width=0.2, position=position_dodge(0.9)) + 
  scale_x_continuous(breaks = seq(5,25,5)) +
  ggtitle(paste('Value search starting point', val_start2plot))

# ggplot(val_plot_re[val_plot_re$val_start ==val_start2plot,], aes(x=reward, y=val_mon_norm)) + 
#   geom_point() +
#   geom_smooth(method = 'nls', formula = y~ power(x)) +
#   # geom_smooth(method = "gam") +
#   scale_x_continuous(breaks = seq(5,25,5)) +
#   ggtitle(paste('Value search starting point', val_start2plot))
```


Plot normalized value parameters, monetary
```{r}
val_start2plot = 3
val2plot <- data_summary(val_plot_re[val_plot_re$val_start ==val_start2plot,],
                         varname = 'val_mon_norm',
                         groupnames = 'level')

ggplot(val2plot, aes(x=level, y=val_mon_norm)) + 
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=val_mon_norm-sd, ymax=val_mon_norm+sd), width=0.2, position=position_dodge(0.9)) + 
  ggtitle(paste('Value search starting point', val_start2plot))


val2plot <- data_summary(val_plot_re[val_plot_re$val_start ==val_start2plot,],
                         varname = 'val_mon_norm',
                         groupnames = 'reward')

ggplot(val2plot, aes(x=reward, y=val_mon_norm)) + 
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=val_mon_norm-sd, ymax=val_mon_norm+sd), width=0.2, position=position_dodge(0.9)) + 
  scale_x_continuous(breaks = seq(5,25,5)) +
  ggtitle(paste('Value search starting point', val_start2plot))

# ggplot(val_plot_re[val_plot_re$val_start ==val_start2plot,], aes(x=reward, y=val_mon_norm)) + 
#   geom_point() +
#   geom_smooth(method = 'nls', formula = y~ power(x)) +
#   # geom_smooth(method = "gam") +
#   scale_x_continuous(breaks = seq(5,25,5)) +
#   ggtitle(paste('Value search starting point', val_start2plot))
```

Plot value parameters, medical
```{r}
val_start2plot = 3
val2plot <- data_summary(val_plot_re[val_plot_re$val_start ==val_start2plot,],
                         varname = 'val_med',
                         groupnames = 'level')

ggplot(val2plot, aes(x=level, y=val_med)) + 
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=val_med-sd, ymax=val_med+sd), width=0.2, position=position_dodge(0.9)) + 
  ggtitle(paste('Value search starting point', val_start2plot))

```

Plot normalized value parameters, medical
```{r}
val_start2plot = 3
val2plot <- data_summary(val_plot_re[val_plot_re$val_start ==val_start2plot,],
                         varname = 'val_med_norm',
                         groupnames = 'level')

ggplot(val2plot, aes(x=level, y=val_med_norm)) + 
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=val_med_norm-sd, ymax=val_med_norm+sd), width=0.2, position=position_dodge(0.9)) + 
  ggtitle(paste('Value search starting point', val_start2plot))

```

Comparing adjusted BIC
```{r}
monpar_plot <- data.frame('BIC_1' = fit1$BIC_mon,'BIC_2'= fit2$BIC_mon, 'BIC_3' = fit3$BIC_mon)
chart.Correlation(monpar_plot)

medpar_plot <- data.frame('BIC_1' = fit1$BIC_med,'BIC_2'= fit2$BIC_med, 'BIC_3' = fit3$BIC_med)
chart.Correlation(medpar_plot)
```

alpha
```{r}
monpar_plot <- data.frame('alpha_1' = fit1$alpha_mon,'alpha_2'= fit2$alpha_mon, 'alpha_3' = fit3$alpha_mon)
chart.Correlation(monpar_plot)

monpar_plot <- data.frame('alpha_1' = fit1$alpha_mon,'alpha_2'= fit2$alpha_mon)
chart.Correlation(monpar_plot)

medpar_plot <- data.frame('alpha_1' = fit1$alpha_med,'alpha_2'= fit2$alpha_med, 'alpha_3' = fit3$alpha_med)
chart.Correlation(medpar_plot)
```

beta
```{r}
monpar_plot <- data.frame('beta_1' = fit1$beta_mon,'beta_2'= fit2$beta_mon, 'beta_3' = fit3$beta_mon)
chart.Correlation(monpar_plot, histogram = TRUE)
# chart.Correlation(monpar_plot[monpar_plot$beta_100<400,], histogram = TRUE)


medpar_plot <- data.frame('beta_1' = fit1$beta_med,'beta_2'= fit2$beta_med, 'beta_3' = fit3$beta_med)
chart.Correlation(medpar_plot, histogram = TRUE)
# chart.Correlation(medpar_plot[medpar_plot$beta_100>-100,])

# View(fit3)
```

```{r}
# sort fit1 and fit2 by id
par_plot <- data.frame('r2_1' = fit1$r2_adj_mon,'r2_2'= fit2$r2_adj_mon)

ggplot(par_plot, aes(x=r2_1, y=r2_2)) +
  geom_point() +
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0,1)) +
  geom_abline(intercept = 0, slope = 1, color = "blue") +
  xlab('Grid step = 0.5') + ylab('Grid step = 0.2')
```



```{r}
ggplot(fit2, aes(x=beta_mon, y=beta_med)) +
  geom_point() +
  geom_smooth(method = "lm")
  # scale_x_continuous(limits=c(-1.5, 6)) +
  # scale_y_continuous(limits=c(-1.5, 6)) +
  # geom_abline(intercept = 0, slope = 1, color = "blue")

print(corr.test(x = fit2$beta_mon,
          y = fit2$beta_med,
          method = "spearman"),
      digits = 7)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
